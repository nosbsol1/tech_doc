# Webサーバーの構成  

## なにこれ？  
別の記事で紹介したWebサーバーの部分についてより詳しく説明します。  



図


## Webサーバーアプリの役割  
Webサーバーアプリの主な機能は、クライアントからのHTTPリクエストを受け取り、応答としてhtmlなどを返却することです。   
ただそれだけでは無く、他にも以下のようなことが出来ます。  

- 特定IPアドレスの場合フィルタ（リクエストを許可/拒否）する
- 特定URLの場合リダイレクトさせる
- 特定URLの拒否
- SSL化による通信の暗号化
- リクエストに応じて特定のサーバへ処理を振り分ける
- リクエスト・レスポンスヘッダーの書き換え

このように、Httpリクエストをどうさばくかを定義できるのがWebサーバーアプリです。  


### 代表的なWebサーバーアプリ

- nginx


- apache Http Server


- IIS



## Webサーバーアプリで出来ないこと（動的コンテンツの作成）

Webサーバーアプリだけでもクライアントからのリクエストに応答できるのですが、Webサーバーアプリだけだと実現しにくい機能があります。  
それが**動的コンテンツ**の作成です。   
対になる**静的コンテンツと**一緒に以下説明します。  

- 静的コンテンツ  
閲覧する条件によって内容が変わらないコンテンツ。  
ヘルプページや利用規約ページのhtmlや、画像ファイルや外部ファイルとして定義してcss、javascriptなど。    

- 動的コンテンツ  
閲覧する条件によって内容が変わるコンテンツ。  
例えばマイページのようなユーザーによって内容が変わるWebページや、検索条件によって内容が変わる商品一覧ページのhtmlなど。    
弊社の案件で開発するWebシステムの場合、このような動的コンテンツを作成する必要があることがほとんどです。  


動的コンテンツを作成する為には、DBなどから動的に変わる箇所の情報（ユーザー名など）を取得し、それをもとに返却するコンテンツ（Htmlなど）を作成する、といった処理を行うプログラムが必要になります。  
（このようなプログラムはJavaやC#などで実装します。） 

ただ、Webサーバーアプリにはそのようなプログラムを動かす機能がありません*。  
そのため、プログラムを動作させるためのアプリが必要になります。  
そのようなアプリを**アプリケーションサーバーアプリ**といいます。 
   

*後述しますがWebサーバーアプリや言語によってはプログラムを動作させることも出来ます。  ただその場合でも役割を分けることが多いです。  


## アプリケーションサーバーアプリ 
javaやC#などで作成したプログラムを動作させるためのサーバーアプリです。  
以下の処理を行います。  

1. Httpリクエストを受け取る

1. リクエスト内容に応じたプログラムを実行し、DBとのやり取りやブラウザに返却するコンテンツ(Html)の作成を行う。  


1. 結果をHttpレスポンスで返却

図


（以下アプリケーションサーバーをAppサーバーと呼びます。）  

プログラムを実行させるためには、Appサーバーアプリだけではなく各言語の実行環境(SDK)も必要になります。  
例えばJavaのプログラムを実行するTomcatというAppサーバーアプリを利用したい場合、JDKのインストールや環境変数（JAVA_HOME）の設定などの作業が必要になります。  

またAppサーバーアプリが稼働しているサーバーをAppサーバーと言います。  


## WebサーバーとAppサーバーの違い   
上述のようにAppサーバーアプリにもHttpリクエストを受け付けてレスポンスを返す機能があります。  
また、Appサーバーでも静的コンテンツを返すことが可能です。  
このようにAppサーバーはWebサーバーと同じような機能を持っています。

それではこの２つの違いは何でしょうか。   
それは、役割の専門性の違いです。  

AppサーバーではHttpリクエストを受け付けることは出来ますが、WebサーバーのようなHTTP関連の様々な処理（特定のサーバへ処理を振り分けなど）を行うことは出来ません。  
（出来たとしてもWebサーバーより実装が大変なことが多いです。）  

WebサーバーはHttp関連の処理は得意ですが、前述したとおりJavaなどのプログラムを動作させることは出来ません。（ただし一部の言語は動作させれます。）  

このように出来ることは似ていても、得意な処理が異なっています。  

- Webサーバー  
Http周りの処理がメイン。  

- Appサーバー  
プログラムを稼働させるのがメイン。  


|   |  Webサーバー  |  Appサーバー  |
| ---- | ---- | ---- |
|  HTTP通信  |  得意  |  必要最低限  |

## WebサーバーとAppサーバーの使い分け  
ではWebサーバーとAppサーバーをどのように使い分けるのでしょうか。
結論から言うと、両方を同時に使うことが多いです。   
それぞれが得意な部分の処理を担当するイメージです。  

２つを同時に使う場合の処理の流れは以下になります。  

1. （Webサーバー）クライアントからのリクエストを受け取る  

1. （Webサーバー）必要に応じた処理を実行（ヘッダーの書き換えなど）  

1. （Webサーバー）AppサーバーにHttpリクエストを転送  
Webサーバーが受け取り必要な変更を加えたHttpリクエストを、WebサーバーがクライアントになりAppサーバーに発行するイメージです。  

1. （Appサーバー）Webサーバーから転送されたリクエストを受け取り、リクエストに応じてプログラムを実行  

1. （Appサーバー）WebサーバーにHttpレスポンスで結果を返却

1. （Webサーバー）Appサーバーから受け取ったHttpレスポンスに対し、必要に応じた処理（ヘッダーの書き換えなど）を実行  

1. （Webサーバー）クライアントにHttpレスポンスを返却  

図  


このように両方のアプリを同時に使い、それぞれの得意な部分の処理を行うようにすることで、負荷分散や拡張性や保守性が高くなります。  
（例えば、なんらかの理由でAppサーバーを停止する場合に、Webサーバーの方でメンテンナンス中ページを返す、といったことも可能になります。）  

その為、案件で開発するようなシステムの場合は、２つを同時に使うケースが大半です。  

ただ社内の数人しか使わないサイトや、開発中のページを確認したいだけの用途の場合などは、Appサーバーだけを利用する事もあります。  


## WebサーバーとAppサーバーの構成  
WebサーバーとAppサーバーは同時に利用することが多いと書きましたが、サーバーの構成としてはどうなるでしょうか。  

それは、WebサーバーとAppサーバーを別々のサーバーとする場合と、1台のサーバーに同居させる場合があります。  

- 別々のサーバーとする場合  
アクセス数が多い場合などは、別々のサーバーとすることがあります。  
負荷分散や拡張性が高くなります。 

図

Webサーバーアプリにはリクエストを転送する為の設定を記述できますので、そこにAppサーバーのアドレスとポートを記載します。 

例  


- 1台のサーバーに同居させる場合  



アクセス数がそこまで多くない場合など、1台のサーバーに同居させる場合があります。  
この場合、Webサーバーは80(HTTP)、443(HTTPS)ポートをリッスンし、Appサーバーは空いている適当なポートをリッスンします。(8080や8443が使われることが多いです)  
Webサーバーはlocalhostに対してリクエストを転送します。  

図  


### 代表的なAppサーバーアプリ  
言語によって異なります。  

|  言語  |  Appサーバー  |
| ---- | ---- |
|  Java  |  Tomcat、JBoss、Glass Fish  |
|  C#  |  IIS（Webサーバー兼Appサーバーとなる）  |
|  Ruby  |  Unicorn、Rainbows  |
|  PHP  | apache HTTP Serverのプラグイン（Webサーバー兼Appサーバーとなる）  |



## アプリケーションサーバー上で動作するプログラムの実装  
主要な開発言語にはアプリケーションサーバー上で動作するプログラム（以下Webアプリと呼びます）を作成するためのライブラリやフレームワークが用意されています。  

それらのライブラリのフレームワークのルールに乗っ取って処理を実装していきます。  
（例えばWebサーバーアプリが起動したときにはこのメソッドが呼ばれる、URLと対応するメソッドは項定義する、リクエストボディの内容はこの変数に入っている　など）


例

同じ言語でも異なるフレームワークを使うと実装方法が異なります。  

javaの場合  

- Servlet  
Webアプリケーション実装時の仕様。  
例えば以下のような仕様が定義されている。  
  - Webサーバーアプリが起動したときにはこのメソッドが呼ばれる
  - URLと対応するメソッドは項定義する
  - リクエストボディの内容はこの変数に入っている  
  など

- j2ee.jar  
サーブレットの仕様通りに実装されたライブラリ。  
各Appサーバーが用意している。  
またeclipseなどのIDEでも用意されている事が多い。  
(開発時はIDEのjarを利用し、本番時は配置先のAppサーバーのjarを利用する。)

図  


標準のサーブレットだと記述が上長になる為、外部のWebフレームワークライブラリを利用する事も多いです。  
著名なWebフレームワークであるSpringBootを利用すると、Appサーバー(Tomcat)自身を内包した形でプログラムをビルドすることも可能です。  
この場合、Appサーバーアプリがインストールされていない環境でもそのまま実行できます。  
（実行すると作成したプログラムが配置されたTomcatが立ち上がる。）  
こちらの形式の方が取り回ししやすい為、最近のアプリはこの形式が多いです。  

図  

.NETも今はこの形式になっています。  


## DBサーバー
APPサーバーのプログラム（Webアプリ）はDBから取得したデータをもとにクライアントへの返却結果を作成する事が多いです。  

ここではDBサーバーについても簡単に説明します。  

DBサーバーとは簡単に言うと、DBアプリケーション（以下DBと呼びます）が稼働しているサーバーです。  
DBについて代表的なものは以下になります。  

- mysql
- SQLServer
- Oracle
- Postgres
- DB2

各DB毎にデフォルトでリッスンするポートが決まっています。    

|  DB  |  ポート  |
| ---- | ---- |
|  mysql  |  1433  |


このポートに対してWebアプリから認証要求や実行したいSQLを送信します。  

図



## AppサーバーからDBサーバーへのアクセス  
Webアプリ側はDBに対して認証処理をしたり、SQL文を送って結果を受け取る処理を実装する必要があります。   
ただしこれらを1から実装すると大変なので、それらの処理をまとめたライブラリを利用する事が大半です。  
DBの開発元が各言語向けのライブラリを作成しており、無料で取得することが出来ます。（主要な言語向けのものは大抵はあります。）  

このライブラリがコネクション処理やSQL発行の為にDBとやり取りする部分の処理を実装してくれているので、WebアプリはそれにSQLや接続文字列を渡すだけで良くなります。  

図  

大抵のDBは以下のような処理を行います。

- DBへの接続  
DBに対して認証処理を行い、WebアプリからDBに対してSQL実行などを出来るようにします。  

DBサーバーのアドレス、ユーザー名、パスワードなどをまとめた文字列を渡すとDBとの間にコネクションを貼ってくれます。  
これを接続文字列といいます。  

- SQLの発行
その後実行したいSQLを渡すとそのSQLを実行してくれて、実行結果を返却してくれます。  
SQLに埋め込むパラメータの渡し方や、結果の取り出し方はライブラリによって異なります。  

コード例  


#### Appサーバーへのプログラムのデプロイ  
デプロイとは「配置する」、「展開する」という意味で、作成したプログラムをAppサーバーに配置する際などに使われる言葉です。  

デプロイ方法は各APPサーバーにより異なります。  
基本的にビルドしたプログラムを特定のフォルダに配置し、パスやポートと対応付ける設定を行います。  
それを簡単に行うための機能が用意されているAppサーバーも多いです。  

例  
IISの例  

Tomcatの例  


